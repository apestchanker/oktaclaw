services:
  openclaw-gateway:
    image: ${OPENCLAW_IMAGE:-openclaw:local}
    container_name: openclaw-gateway
    restart: unless-stopped
    init: true
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    pids_limit: 256
    tmpfs:
      - /tmp:rw,noexec,nosuid,nodev,size=64m

    environment:
      HOME: /home/node
      TERM: xterm-256color
      NODE_ENV: production

      OPENCLAW_CONFIG_PATH: /home/node/.openclaw/openclaw.json
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}

      # Security profile: disable unneeded method surfaces.
      OPENCLAW_SECURITY_PROFILE: minimal
      OPENCLAW_DISABLE_BROWSER_API: "1"
      OPENCLAW_DISABLE_SKILLS_API: "1"
      OPENCLAW_DISABLE_WIZARD_API: "1"
      OPENCLAW_DISABLE_UPDATE_API: "1"
      OPENCLAW_DISABLE_TTS_API: "1"
      OPENCLAW_DISABLE_TALK_API: "1"
      OPENCLAW_DISABLE_CRON_API: "1"
      OPENCLAW_DISABLE_NODES_API: "1"
      OPENCLAW_DISABLE_EXEC_APPROVALS_API: "1"
      OPENCLAW_DISABLE_VOICEWAKE_API: "1"
      OPENCLAW_DISABLE_DEVICE_API: "1"

      # Channel hardening: only load Telegram channel plugin.
      OPENCLAW_CHANNEL_ALLOWLIST: telegram

      # Remove bundled skills from resolution path.
      OPENCLAW_BUNDLED_SKILLS_DIR: /opt/openclaw-empty/skills

      # Disable mDNS even if config drifts.
      OPENCLAW_DISABLE_BONJOUR: "1"

    volumes:
      - ${OPENCLAW_STATE_DIR}:/home/node/.openclaw:rw

    ports:
      - "127.0.0.1:${OPENCLAW_GATEWAY_PORT:-18789}:18789"

    command:
      [
        "node",
        "openclaw.mjs",
        "gateway",
        "--bind",
        "loopback",
        "--port",
        "18789"
      ]

  openclaw-acp:
    image: ${OPENCLAW_IMAGE:-openclaw:local}
    container_name: openclaw-acp
    profiles: ["acp"]
    init: true
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    pids_limit: 128
    tmpfs:
      - /tmp:rw,noexec,nosuid,nodev,size=32m
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_CONFIG_PATH: /home/node/.openclaw/openclaw.json
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
    volumes:
      - ${OPENCLAW_STATE_DIR}:/home/node/.openclaw:rw
    entrypoint: ["node", "openclaw.mjs", "acp", "--url", "ws://127.0.0.1:18789", "--token", "${OPENCLAW_GATEWAY_TOKEN}"]
    network_mode: service:openclaw-gateway
